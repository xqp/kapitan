
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://kapitan.dev/secrets/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.1.11">
    
    
      
        <title>Secret management - Kapitan documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.50e68009.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#kapitan-references-formerly-secrets" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Kapitan documentation" class="md-header__button md-logo" aria-label="Kapitan documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Kapitan documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Secret management
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/kapicorp/kapitan/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    kapicorp/kapitan
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Kapitan documentation" class="md-nav__button md-logo" aria-label="Kapitan documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Kapitan documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/kapicorp/kapitan/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    kapicorp/kapitan
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../contributing/" class="md-nav__link">
        Contributing
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Getting started
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Getting started" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Getting started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kapitan_overview/" class="md-nav__link">
        Kapitan Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../inventory/" class="md-nav__link">
        Inventory
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../compile/" class="md-nav__link">
        Compiling components/templates
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Kapitan features
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Kapitan features" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Kapitan features
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Secret management
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Secret management
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#using-secrets" class="md-nav__link">
    Using Secrets
  </a>
  
    <nav class="md-nav" aria-label="Using Secrets">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-define-your-gpg-recipients-vault-client-parameters-or-kms-key" class="md-nav__link">
    1. Define your GPG recipients, Vault client parameters or KMS key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-create-your-secret" class="md-nav__link">
    2. Create Your Secret
  </a>
  
    <nav class="md-nav" aria-label="2. Create Your Secret">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#manually-via-command-line" class="md-nav__link">
    Manually via command line:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#automatically" class="md-nav__link">
    Automatically
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-reference-your-secrets-in-your-classestargets-and-run-kapitan-compile" class="md-nav__link">
    3. Reference your secrets in your classes/targets and run kapitan compile
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-reveal-and-use-the-secrets" class="md-nav__link">
    4. Reveal and use the secrets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-compile-refs-in-embedded-format" class="md-nav__link">
    5. Compile refs in embedded format
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#secret-sub-variables" class="md-nav__link">
    Secret Sub-Variables
  </a>
  
    <nav class="md-nav" aria-label="Secret Sub-Variables">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#environment-references-backend" class="md-nav__link">
    Environment References Backend
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vaultkv-secret-backend-read-only-addons" class="md-nav__link">
    Vaultkv Secret Backend (Read Only) - Addons
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#azure-kms-secret-backend" class="md-nav__link">
    Azure KMS Secret Backend
  </a>
  
    <nav class="md-nav" aria-label="Azure KMS Secret Backend">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#defining-the-kms-key" class="md-nav__link">
    Defining the KMS key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-a-secret" class="md-nav__link">
    Creating a secret
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#referencing-and-revealing-a-secret" class="md-nav__link">
    Referencing and revealing a secret
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../validate/" class="md-nav__link">
        Manifest validation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../external_dependencies/" class="md-nav__link">
        External dependency management
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Miscellaneous
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Miscellaneous" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Miscellaneous
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../usage/" class="md-nav__link">
        Usage
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../proposals/" class="md-nav__link">
        Proposals
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Examples
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Examples" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Examples
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../example-kubernetes/" class="md-nav__link">
        Kubernetes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../example-terraform/" class="md-nav__link">
        Terraform
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#using-secrets" class="md-nav__link">
    Using Secrets
  </a>
  
    <nav class="md-nav" aria-label="Using Secrets">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-define-your-gpg-recipients-vault-client-parameters-or-kms-key" class="md-nav__link">
    1. Define your GPG recipients, Vault client parameters or KMS key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-create-your-secret" class="md-nav__link">
    2. Create Your Secret
  </a>
  
    <nav class="md-nav" aria-label="2. Create Your Secret">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#manually-via-command-line" class="md-nav__link">
    Manually via command line:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#automatically" class="md-nav__link">
    Automatically
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-reference-your-secrets-in-your-classestargets-and-run-kapitan-compile" class="md-nav__link">
    3. Reference your secrets in your classes/targets and run kapitan compile
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-reveal-and-use-the-secrets" class="md-nav__link">
    4. Reveal and use the secrets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-compile-refs-in-embedded-format" class="md-nav__link">
    5. Compile refs in embedded format
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#secret-sub-variables" class="md-nav__link">
    Secret Sub-Variables
  </a>
  
    <nav class="md-nav" aria-label="Secret Sub-Variables">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#environment-references-backend" class="md-nav__link">
    Environment References Backend
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vaultkv-secret-backend-read-only-addons" class="md-nav__link">
    Vaultkv Secret Backend (Read Only) - Addons
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#azure-kms-secret-backend" class="md-nav__link">
    Azure KMS Secret Backend
  </a>
  
    <nav class="md-nav" aria-label="Azure KMS Secret Backend">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#defining-the-kms-key" class="md-nav__link">
    Defining the KMS key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-a-secret" class="md-nav__link">
    Creating a secret
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#referencing-and-revealing-a-secret" class="md-nav__link">
    Referencing and revealing a secret
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
<a href="https://github.com/kapicorp/kapitan/edit/master/docs/secrets.md" title="Edit this page" class="md-content__button md-icon">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
</a>


<h1 id="kapitan-references-formerly-secrets">Kapitan References (Formerly Secrets)</h1>
<p>Kapitan can manage references and secrets with the following key management services:</p>
<ul>
<li>GPG</li>
<li>Google Cloud KMS (beta)</li>
<li>AWS KMS (beta)</li>
<li>Azure KMS (beta)</li>
<li>Environment</li>
<li>Vaultkv (read only support)</li>
</ul>
<p>If you want to get started with secrets but don't have a GPG or KMS setup, you can also use the <code>base64</code> reference type. Note that <code>base64</code> is not encrypted and is intended for development purposes only. <em>Do not use base64 if you're storing sensitive information!</em></p>
<h2 id="using-secrets">Using Secrets</h2>
<p>The usual flow of creating and using an encrypted secret with kapitan is:</p>
<h4 id="1-define-your-gpg-recipients-vault-client-parameters-or-kms-key">1. Define your GPG recipients, Vault client parameters or KMS key</h4>
<p>This is done in the inventory under <code>parameters.kapitan.secrets</code>.</p>
<p>Just like any other inventory parameters, this can be inherited from a common class or defined per target. For example, <code>common.yml</code> may contain:</p>
<div class="highlight"><pre><span></span><code><span class="nt">parameters</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">kapitan</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">vars</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${target_name}</span><span class="w"></span>
<span class="w">      </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${target_name}</span><span class="w"></span>
<span class="w">    </span><span class="nt">secrets</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">gpg</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">recipients</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example@kapitan.dev</span><span class="w"></span>
<span class="w">            </span><span class="nt">fingerprint</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">D9234C61F58BEB3ED8552A57E28DC07A3CBFAE7C</span><span class="w"></span>
<span class="w">      </span><span class="nt">gkms</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;projects/&lt;project&gt;/locations/&lt;location&gt;/keyRings/&lt;keyRing&gt;/cryptoKeys/&lt;key&gt;&#39;</span><span class="w"></span>
<span class="w">      </span><span class="nt">awskms</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;alias/nameOfKey&#39;</span><span class="w"></span>
<span class="w">      </span><span class="nt">azkms</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;https://&lt;keyvault-name&gt;.vault.azure.net/keys/&lt;object-name&gt;/&lt;object-version&gt;&#39;</span><span class="w"></span>
<span class="w">      </span><span class="nt">vaultkv</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">VAULT_ADDR</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://127.0.0.1:8200</span><span class="w"></span>
<span class="w">        </span><span class="nt">auth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">token</span><span class="w"></span>
</code></pre></div>
<h4 id="2-create-your-secret">2. Create Your Secret</h4>
<h5 id="manually-via-command-line">Manually via command line:</h5>
<div class="highlight"><pre><span></span><code>$ kapitan refs --write &lt;secret_type&gt;:path/to/secret/file -t &lt;target_name&gt; -f &lt;secret_file&gt;
</code></pre></div>
<p>​   where <code>&lt;secret_type&gt;</code> can be any of:</p>
<ul>
<li><code>base64</code>: base64 (not encrypted!)</li>
<li><code>gpg</code>: GPG</li>
<li><code>gkms</code>: Google Cloud KMS</li>
<li><code>awskms</code>: AWS KMS</li>
<li><code>azkms</code>: Azure KMS</li>
<li><code>vaultkv</code>: Hashicorp Vault with kv/kv-v2 secret engine</li>
</ul>
<p>Kapitan will inherit the secrets configuration for the specified target, and encrypt and save your secret into <code>&lt;path/to/secret/file&gt;</code>.</p>
<h5 id="automatically">Automatically</h5>
<p>When referencing your secret in the inventory during compile, you can use the following functions to automatically generate, encrypt and save your secret:</p>
<ul>
<li><code>randomstr</code> - Generates a random string. You can optionally pass the length you want i.e. <code>||randomstr:32</code></li>
<li><code>base64</code> - base64 encodes your secret; to be used as a secondary function i.e. <code>||randomstr|base64</code></li>
<li><code>sha256</code> - sha256 hashes your secret; to be used as a secondary function i.e. <code>||randomstr|sha256</code>. You can optionally pass a salt i.e <code>||randomstr|sha256:salt</code> -&gt; becomes <code>sha256("salt:&lt;generated random string&gt;")</code></li>
<li><code>reveal</code> - Decrypts a secret; to be used as a secondary function, useful for reuse of a secret like for different encodings i.e <code>||reveal:path/to/secret|base64</code></li>
<li><code>rsa</code> - Generates an RSA 4096 private key (PKCS#8). You can optionally pass the key size i.e. <code>||rsa:2048</code></li>
<li><code>ed25519</code> - Generates a ed25519 private key (PKCS#8).</li>
<li><code>publickey</code> - Derives the public key from a revealed private key i.e. <code>||reveal:path/to/encrypted_private_key|publickey</code></li>
<li><code>rsapublic</code> - Derives an RSA public key from a revealed private key i.e. <code>||reveal:path/to/encrypted_private_key|rsapublic</code> (deprecated, use <code>publickey</code> instead)</li>
</ul>
<p><em>Note</em>: The first operator here <code>||</code> is more similar to a logical OR. If the secret file doesn't exist, kapitan will generate it and apply the functions after the <code>||</code>. If the secret file already exists, no functions will run.</p>
<p><em>Note</em>: If you use <code>|reveal:/path/secret</code>, when changing the <code>/path/secret</code> file make sure you also delete any secrets referencing <code>/path/secret</code> so kapitan can regenerate them.</p>
<p><em>Note</em>: <code>vaultkv</code> can't be used to generate secrets automatically for now, manually create the secret using the command line.</p>
<h4 id="3-reference-your-secrets-in-your-classestargets-and-run-kapitan-compile">3. Reference your secrets in your classes/targets and run <code>kapitan compile</code></h4>
<p>Secrets can be referenced in the format <code>?{&lt;secret_type&gt;:path/to/secret/file}</code>.</p>
<p>For example, assume for now that your GPG-encrypted secret is already stored in a file at <code>targets/secrets/mysql_password</code>. This can be referenced in the inventory in the following format:</p>
<div class="highlight"><pre><span></span><code><span class="nt">users</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">root</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="c1"># If &#39;secrets/targets/${target_name}/mysql/password&#39; doesn&#39;t exist, we can automatically generate a random b64-encoded password as follows</span><span class="w"></span>
<span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">?{gpg:targets/${target_name}/mysql/password|randomstr|base64}</span><span class="w"></span>
</code></pre></div>
<p>During compile, kapitan will search for the path <code>targets/${target_name}/mysql/password</code>. Should it not exist, then it will automatically generate a random base64 password and save it to that path.</p>
<h4 id="4-reveal-and-use-the-secrets">4. Reveal and use the secrets</h4>
<p>You can reveal the secrets referenced in the outputs of <code>kapitan compile</code> via:</p>
<div class="highlight"><pre><span></span><code>$ kapitan refs --reveal -f path/to/rendered/template
</code></pre></div>
<p>For example, <code>compiled/minikube-mysql/manifests/mysql_secret.yml</code> with the following content:</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"></span>
<span class="nt">data</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">MYSQL_ROOT_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">?{gpg:targets/minikube-mysql/mysql/password:ec3d54de}</span><span class="w"></span>
<span class="w">  </span><span class="nt">MYSQL_ROOT_PASSWORD_SHA256</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">?{gpg:targets/minikube-mysql/mysql/password_sha256:122d2732}</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span><span class="w"></span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example-mysql</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example-mysql</span><span class="w"></span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">minikube-mysql</span><span class="w"></span>
<span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Opaque</span><span class="w"></span>
</code></pre></div>
<p>can be revealed as follows:</p>
<div class="highlight"><pre><span></span><code>$ kapitan refs --reveal -f compiled/minikube-mysql/manifests/mysql_secret.yml
</code></pre></div>
<p>This will substitute the referenced secrets with the actual decrypted secrets stored at the referenced paths and display the file content.</p>
<p>You can also use:</p>
<div class="highlight"><pre><span></span><code>$ kapitan refs --reveal --ref-file refs/targets/all-glob/mysql/password
</code></pre></div>
<p>or</p>
<div class="highlight"><pre><span></span><code>$ kapitan refs --reveal --tag &quot;?{base64:targets/all-glob/mysql/password}&quot;
$ # or
$ kapitan refs --reveal --tag &quot;?{base64:targets/all-glob/mysql/password:3192c15c}&quot;
</code></pre></div>
<p>for more convenience.</p>
<h4 id="5-compile-refs-in-embedded-format">5. Compile refs in embedded format</h4>
<p>This allows revealing compiled files without needing access to ref files by using:</p>
<div class="highlight"><pre><span></span><code>$ kapitan compile --embed-refs
</code></pre></div>
<p>Compiled files containing refs will now have the references embedded in the compiled file under the following format (gkms backend used as an example):</p>
<div class="highlight"><pre><span></span><code>?{gkms:ReallyLongBase64HereZ2FyZ2FiZQo=:embedded}
</code></pre></div>
<p>Which means that compiled outputs can now be completely distributed (e.g. in CI/CD systems that apply changes) without the need to access the refs directory.</p>
<p>You can also check out <a href="https://github.com/kapicorp/tesoro">Tesoro</a> for Kubernetes which will reveal embedded secret refs in the cluster.</p>
<h2 id="secret-sub-variables">Secret Sub-Variables</h2>
<p>As illustrated above, one file corresponds to one secret. It is now possible for users who would like to reduce the decryption overhead to manually create a yaml file that contains multiple secrets, each of which can be referenced by its object key. For example, consider the secret file <code>refs/mysql_secrets</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nt">mysql_passwords</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">secret_foo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hello_world</span><span class="w"></span>
<span class="w">  </span><span class="nt">secret_bar</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">54321password</span><span class="w"></span>
</code></pre></div>
<p>This can be manually encrypted by:</p>
<div class="highlight"><pre><span></span><code>$ kapitan refs --write gpg:components/secrets/mysql_secrets -t prod -f secrets/mysql_secrets
</code></pre></div>
<p>To reference <code>secret_foo</code>inside this file, you can specify it in the inventory as follows:</p>
<p><code>secret_foo: ${gpg:components/secrets/mysql_secrets@mysql_passwords.secret_foo}</code></p>
<h3 id="environment-references-backend">Environment References Backend</h3>
<p>It may be useful in some occasions when revealing references to have the values for the reference dynamically
come from the environment in which Kapitan is executing. This backend provides such functionality. It will attempt
to locate a value for a reference from the environment using a prefixed variable <em><code>$KAPITAN_VAR_*</code></em> convention
and use this value with the refs command.</p>
<div class="highlight"><pre><span></span><code>$ <span class="nb">echo</span> <span class="s2">&quot;my_default_value&quot;</span> <span class="p">|</span> kapitan refs --write env:path/to/secret_inside_kapitan -t &lt;target_name&gt; -f -
</code></pre></div>
<p>When this reference is created and then referred to in the parameters, it will use the last path component, from a
split, to locate a variable in the current environment to use as the value. If this variable cannot be found in the
environment, it will use the default value written to the refs file on the filesystem.</p>
<div class="highlight"><pre><span></span><code><span class="nt">parameters</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">mysql_passwordS</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">secret_foo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">?{env:my/mysql/mysql_secret_foo}</span><span class="w"></span>
<span class="w">    </span><span class="nt">secret_bar</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">?{env:my/mysql/mysql_secret_bar}</span><span class="w"></span>
</code></pre></div>
<p>When using the above parameters reference, values would be consulted in the environment from the following
variables:</p>
<ul>
<li><code>$KAPITAN_VAR_mysql_secret_foo</code></li>
<li><code>$KAPITAN_VAR_mysql_secret_bar</code></li>
</ul>
<h3 id="vaultkv-secret-backend-read-only-addons">Vaultkv Secret Backend (Read Only) - Addons</h3>
<p>Considering a key-value pair like <code>my_key</code>:<code>my_secret</code> in the path <code>secret/foo/bar</code> in a kv-v2(KV version 2) secret engine on the vault server, to use this as a secret use:</p>
<div class="highlight"><pre><span></span><code>$ <span class="nb">echo</span> <span class="s2">&quot;foo/bar:my_key&quot;</span>  <span class="p">|</span> kapitan refs --write vaultkv:path/to/secret_inside_kapitan -t &lt;target_name&gt; -f -
</code></pre></div>
<p>Parameters in the secret file are collected from the inventory of the target we gave from CLI <code>-t &lt;target_name&gt;</code>. If target isn't provided then kapitan will identify the variables from the environment when revealing secret.</p>
<p>Environment variables that can be defined in kapitan inventory are <code>VAULT_ADDR</code>, <code>VAULT_NAMESPACE</code>, <code>VAULT_SKIP_VERIFY</code>, <code>VAULT_CLIENT_CERT</code>, <code>VAULT_CLIENT_KEY</code>, <code>VAULT_CAPATH</code> &amp; <code>VAULT_CACERT</code>.
Extra parameters that can be defined in inventory are:
* <code>auth</code>: specify which authentication method to use like <code>token</code>,<code>userpass</code>,<code>ldap</code>,<code>github</code> &amp; <code>approle</code>
* <code>mount</code>: specify the mount point of key's path. e.g if path=<code>alpha-secret/foo/bar</code> then <code>mount: alpha-secret</code> (default <code>secret</code>)
* <code>engine</code>: secret engine used, either <code>kv-v2</code> or <code>kv</code> (default <code>kv-v2</code>)
Environment variables cannot be defined in inventory are <code>VAULT_TOKEN</code>,<code>VAULT_USERNAME</code>,<code>VAULT_PASSWORD</code>,<code>VAULT_ROLE_ID</code>,<code>VAULT_SECRET_ID</code>.</p>
<div class="highlight"><pre><span></span><code><span class="nt">parameters</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">kapitan</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">secrets</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">vaultkv</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">auth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">userpass</span><span class="w"></span>
<span class="w">        </span><span class="nt">engine</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kv-v2</span><span class="w"></span>
<span class="w">        </span><span class="nt">mount</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">team-alpha-secret</span><span class="w"></span>
<span class="w">        </span><span class="nt">VAULT_ADDR</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://127.0.0.1:8200</span><span class="w"></span>
<span class="w">        </span><span class="nt">VAULT_NAMESPACE</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CICD-alpha</span><span class="w"></span>
<span class="w">        </span><span class="nt">VAULT_SKIP_VERIFY</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
<span class="w">        </span><span class="nt">VAULT_CLIENT_KEY</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/path/to/key</span><span class="w"></span>
<span class="w">        </span><span class="nt">VAULT_CLIENT_CERT</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/path/to/cert</span><span class="w"></span>
</code></pre></div>
<h3 id="azure-kms-secret-backend">Azure KMS Secret Backend</h3>
<p>To encrypt secrets using keys stored in Azure's Key Vault, a <code>key_id</code> is required to identify an Azure key object uniquely.
It should be of the form <code>https://{keyvault-name}.vault.azure.net/{object-type}/{object-name}/{object-version}</code>.</p>
<h4 id="defining-the-kms-key">Defining the KMS key</h4>
<p>This is done in the inventory under <code>parameters.kapitan.secrets</code>.
<div class="highlight"><pre><span></span><code><span class="nt">parameters</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">kapitan</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">vars</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${target_name}</span><span class="w"></span>
<span class="w">      </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${target_name}</span><span class="w"></span>
<span class="w">    </span><span class="nt">secrets</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">azkms</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;https://&lt;keyvault-name&gt;.vault.azure.net/keys/&lt;object-name&gt;/&lt;object-version&gt;&#39;</span><span class="w"></span>
</code></pre></div>
The key can also be specified using the <code>--key</code> flag</p>
<h4 id="creating-a-secret">Creating a secret</h4>
<p>Secrets can be created using any of the methods described in the <a href="##2.-Create-Your-Secret">"creating your secret"</a> section.</p>
<p>For example, if the key is defined in the <code>prod</code> target file
<div class="highlight"><pre><span></span><code>$ <span class="nb">echo</span> <span class="s2">&quot;my_encrypted_secret&quot;</span> <span class="p">|</span> kapitan refs --write azkms:path/to/secret_inside_kapitan -t prod -f -
</code></pre></div>
Using the <code>--key</code> flag and a <code>key_id</code>
<div class="highlight"><pre><span></span><code>$ <span class="nb">echo</span> <span class="s2">&quot;my_encrypted_secret&quot;</span> <span class="p">|</span> kapitan refs --write azkms:path/to/secret_inside_kapitan --key<span class="o">=</span>&lt;key_id&gt; -f -
</code></pre></div></p>
<h4 id="referencing-and-revealing-a-secret">Referencing and revealing a secret</h4>
<p>Secrets can be <a href="####3.-Reference-your-secrets-in-your-classes/targets-and-run-kapitan-compile">referenced</a> and <a href="####4.-Reveal-and-use-the-secrets">revealed</a> in any of the ways described above.</p>
<p>For example, to reveal the secret stored at <code>path/to/secret_inside_kapitan</code>
<div class="highlight"><pre><span></span><code>$ kapitan refs --reveal --tag <span class="s2">&quot;?{azkms:path/to/secret_inside_kapitan}&quot;</span>
</code></pre></div></p>
<p><em>Note:</em> Cryptographic algorithm used for encryption is <em>rsa-oaep-256</em>.</p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../compile/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Compiling components/templates" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Compiling components/templates
            </div>
          </div>
        </a>
      
      
        
        <a href="../validate/" class="md-footer__link md-footer__link--next" aria-label="Next: Manifest validation" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Manifest validation
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.092fa1f6.min.js"}</script>
    
    
      <script src="../assets/javascripts/bundle.5a9542cf.min.js"></script>
      
    
  </body>
</html>